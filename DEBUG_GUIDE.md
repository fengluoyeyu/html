# 调试和部署指南

## 当前修复内容

### 1. 文件上传问题修复
- ✅ 修改了文件输入的accept属性，支持所有图片格式
- ✅ 改进了文件类型检查逻辑，支持更多格式
- ✅ 添加了文件读取的错误处理
- ✅ 确保currentFile变量正确保存

### 2. 检测按钮无响应问题修复
- ✅ 添加了OPTIONS方法支持（处理CORS预检请求）
- ✅ 增加了详细的请求日志
- ✅ 使用FormData正确发送文件
- ✅ 添加了测试连接按钮

### 3. 后端错误处理改进
- ✅ 添加了模拟数据模式（USE_MOCK_DATA = True）
- ✅ 错误时自动返回模拟数据，确保前端能显示
- ✅ 添加了/api/test测试端点

## 测试步骤

### 1. 测试API连接
1. 部署后访问AI检测页面
2. 点击"测试连接"按钮（绿色按钮）
3. 应该弹出提示显示"API连接正常"

### 2. 测试文件上传
1. 点击"选择本地文件"按钮或拖拽图片到上传区域
2. 选择任意图片文件（支持JPG、PNG、GIF、BMP、WebP）
3. 图片应该显示在预览区域
4. "开始检测"按钮应该变为可用状态

### 3. 测试检测功能
1. 上传图片后点击"开始检测"按钮
2. 当前使用模拟数据模式，应该立即返回结果
3. 检查控制台（F12）查看详细日志

## 调试模式说明

当前后端设置为调试模式（USE_MOCK_DATA = True）：
- 不会真正执行AI检测
- 返回模拟的检测结果
- 用于验证前后端通信是否正常

要启用真实检测，需要修改app_bml_final.py第1504行：
```python
USE_MOCK_DATA = False  # 改为False使用真实检测
```

## 常见问题排查

### 问题1：文件上传失败
- 检查浏览器控制台是否有错误
- 确认文件大小不超过20MB
- 查看后端日志是否收到请求

### 问题2：检测按钮无响应
- 点击"测试连接"按钮验证API是否正常
- 查看浏览器控制台的网络请求
- 检查后端日志中是否有"收到检测请求"

### 问题3：结果不显示
- 确认handleDetectionResult函数已定义
- 检查js/detection-handler.js是否正确加载
- 查看控制台是否有JavaScript错误

## 后端日志位置

BML平台的日志通常在：
- 实时日志：部署页面的"日志"标签
- 文件日志：/bushu2/nurou/app.log（如果配置了文件日志）

## 下一步优化

1. 确认模型文件路径正确
2. 测试真实的推理功能
3. 优化检测结果的可视化
4. 添加更多的错误恢复机制